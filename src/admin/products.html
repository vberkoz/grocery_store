<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Продукти</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
<h1>Продукти</h1>
<a href="orders.html">Замовлення</a><strong> | </strong>
<a href="products.html">Продукти</a><strong> | </strong>
<a href="categories.html">Категорії</a><strong> | </strong>
<a href="posts.html">Пости</a><strong> | </strong>
<a href="pages.html">Сторінки</a><strong> | </strong>
<a href="users.html">Користувачі</a>
<br>
<br>
<div id="list">
    <table id="products"></table>
    <div style="position: sticky; bottom: 0; background-color: #fff; padding: 30px 60px;">
        <button id="create" onclick="store()">Створити</button>
        <button id="destroy" disabled onclick="destroy()">Видалити</button>
    </div>
</div>
<div id="single" style="display: none;">
    <div id="product"></div>
    <div style="position: sticky; bottom: 0; background-color: #fff; padding: 30px 60px;">
        <button id="back" onclick="back()">Назад</button>
        <button id="update_single" disabled onclick="update()">Зберегти</button>
    </div>
</div>
<script>
    const products = document.getElementById('products');
    const tableHeader = '<tr><th></th><th>Назва продукту</th><th>Назва категорії</th><th>Ціна</th><th>Показувати</th></tr>';
    const product = document.getElementById('product');
    const destroyBtn = document.getElementById('destroy');
    const updateBtn = document.getElementById('update_single');
    const domain = 'http://192.168.1.100:8080/api/v1/';
    let initialState = [];
    let currentState = [];
    let itemsToDestroy = [];

    const initList = () => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', domain + 'products/index')
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send();
        xhr.onload = () => {
            initialState.products = JSON.parse(xhr.response);
            currentState.products = JSON.parse(xhr.response);
            let tr = document.createElement('tr');
            tr.innerHTML = tableHeader;
            products.appendChild(tr);
            initialState.products.map(i => {
                tr = document.createElement('tr');
                tr.innerHTML = `
                    <tr>
                        <td><input class="cbox" type="checkbox" data-id="${i.id}" onclick="checkForDestroy(this)"></td>
                        <td><button class="title" data-id="${i.id}" onclick="showProduct(this)">${i.title}</button></td>
                        <td><span class="category" data-id="${i.id}">${i.category}</span></td>
                        <td><strong class="price" data-id="${i.id}">${i.price}</strong></td>
                        <td><input class="visible" type="checkbox" ${i.visible === "1" ? "checked" : ""}
                            data-id="${i.id}" disabled></td>
                    </tr>`;
                products.appendChild(tr);
            });
        }
    }

    initList();

    const store = () => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', domain + 'product/store');
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send();
        xhr.onload = () => {
            let i = JSON.parse(xhr.response);
            initialState.push(i);
            currentState.push(i);
            initialState = JSON.parse(JSON.stringify(initialState));
            currentState = JSON.parse(JSON.stringify(initialState));
            products.firstChild.remove();
            let tr = document.createElement('tr');
            tr.innerHTML = `
                    <tr>
                        <td><input class="cbox" type="checkbox" data-id="${i.id}" onclick="checkForDestroy(this)"></td>
                        <td><button class="title" data-id="${i.id}" onclick="showProduct(this)">${i.title}</button></td>
                        <td><span class="category" data-id="${i.id}">${i.category}</span></td>
                        <td><strong class="price" data-id="${i.id}">${i.price}</strong></td>
                        <td><input class="visible" type="checkbox" ${i.visible === "1" ? "checked" : ""}
                            data-id="${i.id}" disabled></td>
                    </tr>`;
            products.prepend(tr);
            tr = document.createElement('tr');
            tr.innerHTML = tableHeader;
            products.prepend(tr);
        }
    }

    const update = () => {
        let xhr = new XMLHttpRequest();
        xhr.open("POST", domain + 'product/update');
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send(JSON.stringify(currentState.details.product));
        initialState.details.product = JSON.parse(JSON.stringify(currentState.details.product));
        const id = `[data-id="${initialState.details.product.id}"]`;
        document.querySelector(`${id}[class="title"]`).textContent = initialState.details.product.title_ua;
        document.querySelector(`${id}[class="category"]`).textContent = initialState.details.product.category;
        document.querySelector(`${id}[class="price"]`).textContent = initialState.details.product.price;
        document.querySelector(`${id}[class="visible"]`).checked = parseInt(initialState.details.product.visible);
        updateBtn.disabled = arrayEquals();
        back();
    }

    const changeValue = e => {
        let i = currentState.details.product;
        switch (e.getAttribute('name')) {
            case 'cat_id':
                i.cat_id = e.options[e.selectedIndex].getAttribute('data-category-id');
                i.category = e.options[e.selectedIndex].text;
                break;
            case 'visible': i.visible = e.checked ? '1' : '0'; break;
            default: i[e.getAttribute('name')] = e.value;
        }
        updateBtn.disabled = arrayEquals();
    }

    const arrayEquals = () => {
        let equal = true;
        let o = initialState.details.product;
        for (const p in o) {
            if (o.hasOwnProperty(p) && currentState.details.product.hasOwnProperty(p)) {
                equal ? equal = o[p] === currentState.details.product[p] : null;
            }
        }
        return equal;
    }

    const initSingle = id => {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', domain + 'product/show')
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send(JSON.stringify(id));
        xhr.onload = () => {
            initialState.details = JSON.parse(xhr.response);
            currentState.details = JSON.parse(xhr.response);
            let p = initialState.details.product;
            // p.characteristics = JSON.parse(p.characteristics);
            // console.log(p.characteristics);
            let cs = initialState.details.categories;
            let table = document.createElement('table');
            table.innerHTML = `
                ${inputText('Назва продукту',       p.title_ua,        'title_ua')}
                ${inputText('Product title',        p.title_en,        'title_en')}
                ${inputText('Слаг',                 p.slug_ua,         'slug_ua')}
                ${inputText('Slug',                 p.slug_en,         'slug_en')}
                ${inputText('Зображення',           p.img_ua,          'img_ua')}
                ${inputText('Image',                p.img_en,          'img_en')}
                ${textArea('Корисна інформація',    p.desc_ua,         'desc_ua')}
                ${textArea('Description',           p.desc_en,         'desc_en')}
                ${textArea('Характеристики',        p.char_ua,         'char_ua')}
                ${textArea('Characteristics',       p.char_en,         'char_en')}
                ${inputSelect('Назва категорії',    p.cat_id,   cs,    'cat_id')}
                ${inputText('Код',                  p.code,            'code')}
                ${inputText('Ціна',                 p.price,           'price')}
                ${inputCheckbox('Показувати',       p.visible,         'visible')}
                ${inputText("Об'єм",                p.vol,             'vol')}
                ${inputText("Мін. об'єм",           p.vol_min,         'vol_min')}
                ${inputText("Од. виміру",           p.unit_ua,         'unit_ua')}
                ${inputText("Units",                p.unit_en,         'unit_en')}
            `;
            product.appendChild(table);
        }
    }

    const textArea = (title, value, name) => {
        return `
            <tr>
                <td style="text-align: right">${title}</td>
                <td>
                    <textarea name="${name}" rows="10"
                        style="width: 100%; resize: vertical; font-family: Arial,serif; "
                        onkeyup="changeValue(this)">${value}</textarea>
                </td>
            </tr>
        `;
    }

    const inputCheckbox = (title, value, name) => `
        <tr>
            <td style="text-align: right">${title}</td>
            <td><input name="${name}" type="checkbox" ${value === "1" ? "checked" : ""}
                onclick="changeValue(this)" style="margin-left: 0px;"></td>
        </tr>
    `;

    const inputSelect = (title, id, options, name) => {
        let optionsString = '';
        options.map(i => {
            optionsString += `<option data-category-id="${i.cat_id}" ${i.cat_id === id ? "selected" : ""}>${i.title}</option>`;
        });
        return `
            <tr>
                <td style="text-align: right">${title}</td>
                <td>
                    <select name="${name}" onchange="changeValue(this)">${optionsString}</select>
                </td>
            </tr>
        `;
    }

    const inputText = (title, value, name) => `
        <tr>
            <td style="text-align: right">${title}</td>
            <td><input name="${name}" type="text" value="${value}" onkeyup="changeValue(this)"></td>
        </tr>
    `;

    const back = () => {
        updateBtn.disabled = true;
        product.innerHTML = '';
        document.getElementById('list').style.display = 'block';
        document.getElementById('single').style.display = 'none';
    }

    const showProduct = el => {
        initSingle(el.getAttribute('data-id'));
        document.getElementById('list').style.display = 'none';
        document.getElementById('single').style.display = 'block';
    }

    const destroy = (el) => {
        if (confirm('УВАГА! Цю дію неможливо відмінити. Бажаєте видалити вибрані продукти?')) {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", domain + 'products/destroy');
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            xhr.send(JSON.stringify(itemsToDestroy));
            xhr.onload = () => {
                itemsToDestroy.map(i => {
                    products.querySelector(`[data-id="${i}"]`).parentElement.parentElement.remove()
                });
                itemsToDestroy = [];
                destroyBtn.disabled = !itemsToDestroy.length;
            }
        }
    }

    const checkForDestroy = e => {
        if (e.checked) {
            itemsToDestroy.push(e.getAttribute('data-id'))
        } else {
            itemsToDestroy = itemsToDestroy.filter(i => i !== e.getAttribute('data-id'));
        }
        destroyBtn.disabled = !itemsToDestroy.length;
    }
</script>
</body>
</html>
