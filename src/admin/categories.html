<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Категорії</title>
    <style type="text/css">body {font: 90%/1.25 Verdana,Arial,Helvetica,sans-serif;}</style>
</head>
<body>
<h1>Категорії</h1>
<a href="orders.html">Замовлення</a><strong> | </strong>
<a href="products.html">Продукти</a><strong> | </strong>
<a href="categories.html">Категорії</a><strong> | </strong>
<a href="posts.html">Пости</a><strong> | </strong>
<a href="users.html">Користувачі</a>
<br>
<br>
<table id="categories"></table>
<div style="position: sticky; bottom: 0; background-color: #fff; padding: 5px 30px;">
    <button id="create" onclick="store()">Створити</button>
    <button id="update" disabled onclick="update()">Зберегти</button>
    <button id="destroy" disabled onclick="destroy(this)">Видалити</button>
</div>
<script>
    const table = document.getElementById('categories');
    const tableHeader = '<th></th><th>Назва</th><th>Слаг</th><th>Показувати</th>';
    const updateBtn = document.getElementById('update');
    const destroyBtn = document.getElementById('destroy');
    const domain = 'http://localhost:8080/api/v1/';
    let initialState = [];
    let currentState = [];
    let itemsToDestroy = [];

    const init = () => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', domain + 'categories/index')
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send();
        xhr.onload = () => {
            initialState = JSON.parse(xhr.response);
            currentState = JSON.parse(JSON.stringify(initialState));
            let tr = document.createElement('tr');
            tr.innerHTML = tableHeader;
            table.appendChild(tr);
            initialState.map(i => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <tr>
                        <td><input type="checkbox" data-id="${i.id}" onclick="checkForDestroy(this)"></td>
                        <td><input type="text" value="${i.title}" data-id="${i.id}" name="title" onkeyup="changeValue(this)"></td>
                        <td><input type="text" value="${i.slug}" data-id="${i.id}" name="slug" onkeyup="changeValue(this)"></td>
                        <td><input type="checkbox" ${i.visible === "1" ? "checked" : ""} data-id="${i.id}" name="visible" onclick="changeValue(this)"></td>
                    </tr>`;
                table.appendChild(tr);
            });
        }
    }

    init();

    const changeValue = e => {
        currentState.map(i => {
            if (i.id === e.getAttribute('data-id')) {
                switch (e.getAttribute('name')) {
                    case 'title': i.title = e.value; break;
                    case 'slug': i.slug = e.value; break;
                    case 'visible': i.visible = e.checked ? '1' : '0'; break;
                }
            }
        });
        updateBtn.disabled = arrayEquals();
    }

    const arrayEquals = () => {
        let equal = true;
        if (initialState.length === currentState.length) {
            initialState.forEach((v, i) => {
                equal ? equal = v.title === currentState[i].title : null;
                equal ? equal = v.slug === currentState[i].slug : null;
                equal ? equal = v.visible === currentState[i].visible : null;
            });
            return equal;
        }
        return false;
    }

    const update = () => {
        let xhr = new XMLHttpRequest();
        xhr.open("POST", domain + 'categories/update');
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send(JSON.stringify(currentState));
        initialState = JSON.parse(JSON.stringify(currentState));
        updateBtn.disabled = arrayEquals();
    }

    const store = () => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', domain + 'category/store');
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send();
        xhr.onload = () => {
            let i = JSON.parse(xhr.response);
            initialState.push(i);
            currentState.push(i);
            initialState = JSON.parse(JSON.stringify(initialState));
            currentState = JSON.parse(JSON.stringify(initialState));
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <tr>
                    <td><input type="checkbox" data-id="${i.id}" onclick="checkForDestroy(this)"></td>
                    <td><input type="text" value="${i.title}" data-id="${i.id}" name="title" onkeyup="changeValue(this)"></td>
                    <td><input type="text" value="${i.slug}" data-id="${i.id}" name="slug" onkeyup="changeValue(this)"></td>
                    <td><input type="checkbox" ${i.visible === "1" ? "checked" : ""} data-id="${i.id}" name="visible" onclick="changeValue(this)"></td>
                </tr>`;
            table.appendChild(tr);
        }
    }

    const checkForDestroy = e => {
        if (e.checked) {
            itemsToDestroy.push(e.getAttribute('data-id'))
        } else {
            itemsToDestroy = itemsToDestroy.filter(i => i !== e.getAttribute('data-id'));
        }
        destroyBtn.disabled = !itemsToDestroy.length;
    }

    const destroy = (el) => {
        if (confirm('УВАГА! Цю дію неможливо відмінити. Бажаєте видалити вибрані категорії?')) {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", domain + 'categories/destroy');
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            xhr.send(JSON.stringify(itemsToDestroy));
            xhr.onload = () => {
                itemsToDestroy.map(i => {
                    table.querySelector(`[data-id="${i}"]`).parentElement.parentElement.remove()
                });
                itemsToDestroy = [];
                destroyBtn.disabled = !itemsToDestroy.length;
            }
        }
    }

</script>
</body>
</html>
